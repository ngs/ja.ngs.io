<!DOCTYPE html>
<html âš¡ itemscope itemtype="http://schema.org/Article">
  <head>
    <meta charset="utf-8">
    <title>Swift ã§é–‹ç™ºã—ãŸ Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ Amazon EC2 Container Services (ECS) ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹</title>
    <link itemprop="mainEntityOfPage" rel="canonical" href="https://ja.ngs.io/2016/03/04/swift-webapp-on-ecs/">
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <style amp-custom>
      body {
        background-color: white;
        color: #404040;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        font-size: 14px;
      }
      amp-img {
        background-color: gray;
      }

      .container {
        padding: 0 8px;
      }

      @media (min-width: 480px) {
        .container {
          padding: 0 16px;
        }
      }

    </style>
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
  </head>
  <body>
    <article class="container">
      <h1 itemprop="headline">Swift ã§é–‹ç™ºã—ãŸ Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ Amazon EC2 Container Services (ECS) ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹</h1>
      <h2 itemprop="author" itemscope itemtype="https://schema.org/Person">
        <span itemprop="name">é•·ç€¬ æ•¦å²</span>
      </h2>
      <time itemprop="datePublished" datetime="2016-03-04T13:50:00+00:00">2016-03-04 13:50</time>
      <meta itemprop="description" content="#swiftlang ã§é–‹ç™ºã—ãŸ Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ Amazon EC2 Container Services (ECS) ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦èª¿æŸ»ã—ã¾ã—ãŸ"></meta>
      <div class="hidden article-metadata"><meta content="#swiftlang ã§é–‹ç™ºã—ãŸ Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ Amazon EC2 Container Services (ECS) ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦èª¿æŸ»ã—ã¾ã—ãŸ" itemprop="headline" /><div itemprop="image" itemscope="" itemtype="http://schema.org/ImageObject"><meta content="2016-03-04-swift-webapp-on-ecs/serverspec.png" itemprop="url" /><meta content="732" itemprop="width" /><meta content="481" itemprop="height" /></div><div itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta content="Atsushi Nagase" itemprop="name" /><div itemprop="logo" itemscope="" itemtype="http://schema.org/ImageObject"><meta content="https://ja.ngs.io/images/amp-logo.png" itemprop="url" /><meta content="600" itemprop="width" /><meta content="60" itemprop="height" /></div></div><meta content="2016-03-04T13:50:00" itemprop="dateModified" /></div>
      <h2 id="tl-dr">TL;DR</h2>

<p>Swift ã§ Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹ç™ºã™ã‚‹ã®ã¯ã€ã¨ã¦ã‚‚æ¥½ã—ã„ã§ã™ ğŸ¤˜</p>

<p><a href="https://aws.amazon.com/ecs/">Amazon EC2 Container Services</a> ã«ã‚‚ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ç¨¼åƒã•ã›ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã§ã€è»½é‡ãª <a href="https://www.docker.com/">Docker</a> ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’è‡ªå‹•çš„ã«ãƒ“ãƒ«ãƒ‰ã—ã€é«˜é€Ÿã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ–¹æ³•ã‚’èª¿æŸ»ã—ã¾ã—ãŸã€‚</p>

<p>ã“ã¡ã‚‰ã«ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å…¬é–‹ã—ã¾ã—ãŸã®ã§ã€ã‚ˆã‹ã£ãŸã‚‰å‚è€ƒã«ã—ã¦ã¿ã¦ä¸‹ã•ã„ :point_down:</p>

<ul>
<li><a href="https://github.com/ngs/Swifton-TodoApp">https://github.com/ngs/Swifton-TodoApp</a>
</li><li><a href="https://hub.docker.com/r/atsnngs/docker-swifton-example/">https://hub.docker.com/r/atsnngs/docker-swifton-example/</a>
</li><li><a href="https://circleci.com/gh/ngs/Swifton-TodoApp">https://circleci.com/gh/ngs/Swifton-TodoApp</a>
</li></ul>

<p>ã¾ãŸã€ã“ã¡ã‚‰ã®å†…å®¹ã‚’ã€å¼Šç¤¾ Oneteam ã®ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¹ãƒšãƒ¼ã‚¹ã§è¡Œã£ãŸ <a href="http://connpass.com/event/27667/">Tokyo Server-Side Swift Meetup</a> ã§ç™ºè¡¨ã—ã¾ã—ãŸã€‚</p>

<p>å‚ç…§: <a href="https://one-team.com/blog/ja/2016-03-07-swift-meetup/">https://one-team.com/blog/ja/2016-03-07-swift-meetup/</a></p>

<p>ä»¥ä¸‹ã¯ã€ãã®è³‡æ–™ã§ã™ã€‚</p>





<h2 id="swift-web">Swift ã® Web ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯</h2>

<p>Swift è¨€èªãŒ <a href="https://github.com/apple/swift">ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹</a> ã«ãªã£ã¦ã‹ã‚‰ã€ã„ãã¤ã‹ã® Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãŒã§ã¦ãã¾ã—ãŸã€‚</p>

<ul>
<li><a href="https://developer.ibm.com/swift/products/kitura/">Kitsura</a>
</li><li><a href="https://github.com/nestproject/Nest">Nest</a>
</li><li><a href="http://perfect.org/">Perfect</a>
</li><li><a href="https://github.com/noppoMan/Slimane">Slimane</a>
</li><li><a href="https://github.com/necolt/Swifton">Swifton</a>
</li></ul>

<h2 id="swifton">Swifton</h2>

<p>ã©ã‚ŒãŒä¸€ç•ªè‰¯ã„ã®ã‹ã¯ã€ã¾ã åˆ¤æ–­ã§ãã¦ã„ã¾ã›ã‚“ãŒã€ä»Šå›ã¯ Swift ã§ä½œã£ãŸ Ruby on Rails é¢¨ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ <a href="https://github.com/necolt/Swifton">Swifton</a> ã‚’ä½¿ã£ã¦ã€ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‹•ã‹ã—ã¦ã¿ã¾ã—ãŸã€‚</p>

<p>ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã¯ã€ã¨ã¦ã‚‚ç°¡å˜ã«ç†è§£ã§ãã¾ã™:</p>
<div class="highlight"><pre class="highlight swift"><code><span class="kd">import</span> <span class="kt">Swifton</span>
<span class="kd">import</span> <span class="kt">Curassow</span>

<span class="kd">class</span> <span class="kt">MyController</span><span class="p">:</span> <span class="kt">ApplicationController</span> <span class="p">{</span>
    <span class="k">override</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
        <span class="nf">action</span><span class="p">(</span><span class="s">"index"</span><span class="p">)</span> <span class="p">{</span> <span class="n">request</span> <span class="k">in</span>
            <span class="k">return</span> <span class="k">self</span><span class="o">.</span><span class="nf">render</span><span class="p">(</span><span class="s">"Index"</span><span class="p">)</span>
            <span class="c1">// renders Index.html.stencil in Views directory</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">router</span> <span class="o">=</span> <span class="kt">Router</span><span class="p">()</span>
<span class="n">router</span><span class="o">.</span><span class="nf">get</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="kt">MyController</span><span class="p">()[</span><span class="s">"index"</span><span class="p">])</span>

<span class="n">serve</span> <span class="p">{</span> <span class="n">router</span><span class="o">.</span><span class="nf">respond</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">}</span>
</code></pre></div>
<h2 id="swifton-todoapp">Swifton TodoApp</h2>

<p>Swifton ã¯ã€ToDo ç®¡ç†ã®ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å…¬é–‹ã—ã¦ã„ã¾ã™: <a href="https://github.com/necolt/Swifton-TodoApp">necolt/Swifton-TodoApp</a></p>

<p>ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã€æ—¢ã« Dockerfile ã¨ Heroku ã®è¨­å®š (<code>app.json</code> ã¨ <code>Procfile</code>) ã‚’å«ã‚“ã§ã„ã¾ã™ã€‚</p>

<p>ã“ã‚Œã‚‰ã¯ã€å•é¡Œãªãå‹•ä½œã—ã€ã“ã‚Œã‚’å…ƒã«é–‹ç™ºãŒå§‹ã‚ã‚‰ã‚Œã¾ã™ã€‚ãŸã ã€æœ¬ç•ªé‹ç”¨ã‚’è€ƒæ…®ã™ã‚‹ã¨ã€Heroku ã§ã¯ãªãã€ãªã˜ã¿ã®ã‚ã‚‹ã€Amazon EC2 Container Service (ECS) ã‚’ä½¿ã„ãŸã„ã¨æ€ã„ã¾ã—ãŸã€‚</p>

<h2 id="docker">å¤§ããª Docker ã‚¤ãƒ¡ãƒ¼ã‚¸</h2>

<p>å‰é€”ã®ã¨ãŠã‚Šã€ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ Dockerfile ã‚’å«ã‚“ã§ãŠã‚Šã€ECS ã§ã‚‚å‹•ä½œãŒå¯èƒ½ãª Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>

<p>ã—ã‹ã—ã€ã“ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã¯ã€ã‚³ãƒ³ãƒ†ãƒŠå†…éƒ¨ã§ Swift ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ãŸã‚ã®ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå«ã¾ã‚Œã¦ãŠã‚Šã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºã§ 326 MBã€ä»®æƒ³ã‚µã‚¤ã‚ºã§ 893.2 MB ã‚‚ã®å®¹é‡ã‚’æ¶ˆè²»ã—ã¾ã™ã€‚</p>
<div class="highlight"><pre class="highlight plaintext"><code>REPOSITORY  TAG     IMAGE ID      CREATED         VIRTUAL SIZE
&lt;none&gt;      &lt;none&gt;  sha256:c35f9  30 seconds ago  893.2 MB
</code></pre></div>
<p><amp-img src="/images/2016-03-04-swift-webapp-on-ecs/docker-hub-before.png" layout="responsive" width="1460" height="240"></amp-img></p>

<p>å‚ç…§: <a href="https://hub.docker.com/r/atsnngs/docker-swifton-example/tags/">https://hub.docker.com/r/atsnngs/docker-swifton-example/tags/</a></p>

<p>ãã“ã§ã€ãƒã‚¤ãƒŠãƒªã¯ Docker ãƒ“ãƒ«ãƒ‰ã®å¤–ã§è¡Œã„ã€æœ€å°é™ã®è³‡æã§æ§‹æˆã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ CircleCI ã§æ§‹ç¯‰ã™ã‚‹ã“ã¨ã‚’ã€ãŸã‚ã—ã¦ã¿ã¾ã—ãŸã€‚</p>

<h2 id="circleci-ubuntu-14-04-trusty">CircleCI ã® Ubuntu 14.04 Trusty ã‚³ãƒ³ãƒ†ãƒŠ</h2>

<p>Swift ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã¯ã€Trusty Ubuntu (14.04) ã§ãƒ“ãƒ«ãƒ‰ã•ã‚ŒãŸã€é–‹ç™ºã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä½¿ã„ã¾ã™ã€‚</p>

<p><a href="https://swift.org/download/#latest-development-snapshots">https://swift.org/download/#latest-development-snapshots</a></p>

<p><amp-img src="/images/2016-03-04-swift-webapp-on-ecs/tarball.png" layout="responsive" width="716" height="113"></amp-img></p>

<p>ãã‚Œã«åˆã‚ã›ã¦ã€ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ™ãƒ¼ã‚¿ã¨ã—ã¦æä¾›ã•ã‚Œã¦ã„ã‚‹ã€CircleCI ã® Trusty ã‚³ãƒ³ãƒ†ãƒŠã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚</p>

<p><a href="http://blog.circleci.com/trusty-image-public-beta/">http://blog.circleci.com/trusty-image-public-beta/</a></p>

<p><amp-img src="/images/2016-03-04-swift-webapp-on-ecs/circle-ci-trusty-container.png" layout="responsive" width="1608" height="336"></amp-img></p>

<h2 id="part-f07526a109a5dabb">ç¶™ç¶šãƒ“ãƒ«ãƒ‰ã®ãŸã‚ã®å¿…é ˆã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢</h2>

<p>ã¾ãšã€<code>swift build</code> ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>libicu-dev clang-3.6 jq
<span class="c"># jq ã¯ AWS CLI ã®å¿œç­”ã‚’èª¿æŸ»ã™ã‚‹ãŸã‚ã«ä½¿ã„ã¾ã™ã€‚</span>

<span class="nb">sudo </span>update-alternatives <span class="nt">--install</span> /usr/bin/clang clang /usr/bin/clang-3.6 100
<span class="nb">sudo </span>update-alternatives <span class="nt">--install</span> /usr/bin/clang++ clang++ /usr/bin/clang++-3.6 100
<span class="c"># See: https://goo.gl/hSfhjE</span>
</code></pre></div>
<h2 id="swifton">Swifton ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®è³‡æ</h2>

<ul>
<li>Swift ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã®å…±æœ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒª: <code>usr/lib/swift/linux/*.so</code>
</li><li>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒã‚¤ãƒŠãƒª
</li><li>Stencil ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
</li></ul>

<p>ä¸Šè¨˜ãŒå¿…è¦ãªã®ã§ã€ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã¯ <code>.dockerignore</code> ãƒ•ã‚¡ã‚¤ãƒ«ã§ç„¡è¦–ã—ã€Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰æ™‚é–“ã‚’ç¯€ç´„ã—ã¾ã™ã€‚</p>
<div class="highlight"><pre class="highlight plaintext"><code>*
!Views
!swift/usr/lib/swift/linux/*.so
!.build/release/Swifton-TodoApp
</code></pre></div>
<h2 id="dockerfile">Dockerfile</h2>

<p>Dockerfile ã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚<a href="https://github.com/necolt/Swifton-TodoApp/blob/master/Dockerfile">ã‚ªãƒªã‚¸ãƒŠãƒ«</a> ã«æ¯”ã¹ã¦ã€ã¨ã¦ã‚‚ç°¡ç´ ã§ã™ã€‚</p>
<div class="highlight"><pre class="highlight shell"><code>FROM ubuntu:14.04
MAINTAINER a@ngs.io

RUN apt-get update <span class="o">&amp;&amp;</span> apt-get <span class="nb">install</span> <span class="nt">-y</span> libicu52 libxml2 curl <span class="o">&amp;&amp;</span> <span class="se">\</span>
  apt-get clean <span class="o">&amp;&amp;</span> <span class="se">\</span>
  <span class="nb">rm</span> <span class="nt">-rf</span> /var/lib/apt/lists/<span class="k">*</span> /tmp/<span class="k">*</span> /var/tmp/<span class="k">*</span>

ENV APP_DIR /var/www/app
RUN <span class="nb">mkdir</span> <span class="nt">-p</span> <span class="k">${</span><span class="nv">APP_DIR</span><span class="k">}</span>
WORKDIR <span class="k">${</span><span class="nv">APP_DIR</span><span class="k">}</span>
ADD <span class="nb">.</span> <span class="k">${</span><span class="nv">APP_DIR</span><span class="k">}</span>
RUN <span class="nb">ln</span> <span class="nt">-s</span> <span class="k">${</span><span class="nv">APP_DIR</span><span class="k">}</span>/swift/usr/lib/swift/linux/<span class="k">*</span>.so /usr/lib

EXPOSE 8000
CMD .build/release/Swifton-TodoApp
</code></pre></div>
<p>ã“ã® Dockerfile ã«ã‚ˆã£ã¦ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºã‚’ 88 MBã€ä»®æƒ³ã‚µã‚¤ã‚ºã‚’ 245.8 MB (27.5%) ã¸å‰Šæ¸›ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚</p>
<div class="highlight"><pre class="highlight plaintext"><code>REPOSITORY  TAG     IMAGE ID      CREATED         VIRTUAL SIZE
&lt;none&gt;      &lt;none&gt;  sha256:0d31d  30 seconds ago  245.8 MB
</code></pre></div>
<p><amp-img src="/images/2016-03-04-swift-webapp-on-ecs/docker-hub-after.png" layout="responsive" width="1448" height="146"></amp-img></p>

<h2 id="docker">Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹</h2>

<p><a href="http://serverspec.org/">Serverspec</a> ã‚’ä½¿ã£ã¦ã€Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å®‰å¿ƒã—ã¦åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã€ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>

<p>ä»¥ä¸‹ã®è¨˜äº‹ã«ã€CircleCI ã§ Docker ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã€ã„ãã¤ã‹ã®ã‚³ãƒ„ã¨ã€ãƒ¢ãƒ³ã‚­ãƒ¼ãƒ‘ãƒƒãƒã‚’ç´¹ä»‹ã—ã¦ã„ã¾ã™ã€‚</p>

<p><a href="https://ja.ngs.io/2015/09/26/circleci-docker-serverspec/">https://ja.ngs.io/2015/09/26/circleci-docker-serverspec/</a></p>

<p>ã“ã‚“ãªæ„Ÿã˜ã§ã€ToDo ã‚¢ãƒ—ãƒªã®ãƒ†ã‚¹ãƒˆã‚’æ›¸ãã¾ã—ãŸ:</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="n">port</span><span class="p">(</span><span class="mi">8000</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_listening</span> <span class="p">}</span>
<span class="k">end</span>

<span class="n">describe</span> <span class="n">command</span><span class="p">(</span><span class="s1">'curl -i -s -H \'Accept: text/html\' http://0.0.0.0:8000/'</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">its</span><span class="p">(</span><span class="ss">:exit_status</span><span class="p">)</span> <span class="p">{</span> <span class="n">is_expected</span><span class="p">.</span><span class="nf">to</span> <span class="n">eq</span> <span class="mi">0</span> <span class="p">}</span>
  <span class="n">its</span><span class="p">(</span><span class="ss">:stdout</span><span class="p">)</span> <span class="p">{</span> <span class="n">is_expected</span><span class="p">.</span><span class="nf">to</span> <span class="n">contain</span> <span class="s1">'HTTP/1.1 200 OK'</span> <span class="p">}</span>
  <span class="n">its</span><span class="p">(</span><span class="ss">:stdout</span><span class="p">)</span> <span class="p">{</span> <span class="n">is_expected</span><span class="p">.</span><span class="nf">to</span> <span class="n">contain</span> <span class="s1">'&lt;h1&gt;Listing Todos&lt;/h1&gt;'</span> <span class="p">}</span>
<span class="k">end</span>

<span class="mi">1</span><span class="p">.</span><span class="nf">upto</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">do</span><span class="o">|</span><span class="n">n</span><span class="o">|</span>
  <span class="n">describe</span> <span class="n">command</span><span class="p">(</span><span class="s2">"curl -i -s -H </span><span class="se">\'</span><span class="s2">Accept: text/html</span><span class="se">\'</span><span class="s2"> http://0.0.0.0:8000/todos -d </span><span class="se">\'</span><span class="s2">title=Test</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="se">\'</span><span class="s2">"</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:exit_status</span><span class="p">)</span> <span class="p">{</span> <span class="n">is_expected</span><span class="p">.</span><span class="nf">to</span> <span class="n">eq</span> <span class="mi">0</span> <span class="p">}</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:stdout</span><span class="p">)</span> <span class="p">{</span> <span class="n">is_expected</span><span class="p">.</span><span class="nf">to</span> <span class="n">contain</span> <span class="s1">'HTTP/1.1 302 FOUND'</span> <span class="p">}</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:stdout</span><span class="p">)</span> <span class="p">{</span> <span class="n">is_expected</span><span class="p">.</span><span class="nf">to</span> <span class="n">contain</span> <span class="s1">'Location: /todos'</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">describe</span> <span class="n">command</span><span class="p">(</span><span class="s1">'curl -i -s -H \'Accept: text/html\' http://0.0.0.0:8000/todos'</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">its</span><span class="p">(</span><span class="ss">:exit_status</span><span class="p">)</span> <span class="p">{</span> <span class="n">is_expected</span><span class="p">.</span><span class="nf">to</span> <span class="n">eq</span> <span class="mi">0</span> <span class="p">}</span>
  <span class="n">its</span><span class="p">(</span><span class="ss">:stdout</span><span class="p">)</span> <span class="p">{</span> <span class="n">is_expected</span><span class="p">.</span><span class="nf">to</span> <span class="n">contain</span> <span class="s1">'HTTP/1.1 200 OK'</span> <span class="p">}</span>
  <span class="n">its</span><span class="p">(</span><span class="ss">:stdout</span><span class="p">)</span> <span class="p">{</span> <span class="n">is_expected</span><span class="p">.</span><span class="nf">to</span> <span class="n">contain</span> <span class="s1">'&lt;h1&gt;Listing Todos&lt;/h1&gt;'</span> <span class="p">}</span>
  <span class="n">its</span><span class="p">(</span><span class="ss">:stdout</span><span class="p">)</span> <span class="p">{</span> <span class="n">is_expected</span><span class="p">.</span><span class="nf">to</span> <span class="n">contain</span> <span class="s1">'&lt;td&gt;Test1&lt;/td&gt;'</span> <span class="p">}</span>
  <span class="n">its</span><span class="p">(</span><span class="ss">:stdout</span><span class="p">)</span> <span class="p">{</span> <span class="n">is_expected</span><span class="p">.</span><span class="nf">to</span> <span class="n">contain</span> <span class="s1">'&lt;td&gt;Test2&lt;/td&gt;'</span> <span class="p">}</span>
  <span class="n">its</span><span class="p">(</span><span class="ss">:stdout</span><span class="p">)</span> <span class="p">{</span> <span class="n">is_expected</span><span class="p">.</span><span class="nf">to</span> <span class="n">contain</span> <span class="s1">'&lt;td&gt;&lt;a href="/todos/0"&gt;Show&lt;/a&gt;&lt;/td&gt;'</span> <span class="p">}</span>
  <span class="n">its</span><span class="p">(</span><span class="ss">:stdout</span><span class="p">)</span> <span class="p">{</span> <span class="n">is_expected</span><span class="p">.</span><span class="nf">to</span> <span class="n">contain</span> <span class="s1">'&lt;td&gt;&lt;a href="/todos/1"&gt;Show&lt;/a&gt;&lt;/td&gt;'</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div>
<p><amp-img src="/images/2016-03-04-swift-webapp-on-ecs/serverspec.png" layout="responsive" width="732" height="481"></amp-img></p>

<h2 id="ecs">ECS ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹</h2>

<p>ECS ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¾ãˆã«ã€Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«è»¢é€ (push) ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span>docker tag <span class="nv">$DOCKER_REPO</span> <span class="s2">"</span><span class="k">${</span><span class="nv">DOCKER_REPO</span><span class="k">}</span><span class="s2">:b</span><span class="k">${</span><span class="nv">CIRCLE_BUILD_NUM</span><span class="k">}</span><span class="s2">"</span>
<span class="nv">$ </span>docker push <span class="s2">"</span><span class="k">${</span><span class="nv">DOCKER_REPO</span><span class="k">}</span><span class="s2">:b</span><span class="k">${</span><span class="nv">CIRCLE_BUILD_NUM</span><span class="k">}</span><span class="s2">"</span>
</code></pre></div>
<p>ã“ã“ã§ã¯ã€è©³ã—ã„ã€ECS ç’°å¢ƒã®æ§‹ç¯‰æ–¹æ³•ã¯è§£èª¬ã—ã¾ã›ã‚“ã€<a href="http://docs.aws.amazon.com/ja_jp/AmazonECS/latest/developerguide/ECS_GetStarted.html">AWS ECS ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³</a> ã‚’å‚ç…§ã—ã¦ä¸‹ã•ã„ã€‚</p>

<p><a href="https://github.com/ngs/Swifton-TodoApp/blob/master/script/ecs-deploy-services.sh">ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ</a>ã¯ã€ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ãƒ†ãƒƒãƒ—ã®ä¸­ã§å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚</p>

<p>ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€ä»¥ä¸‹ã®æ“ä½œã‚’ <a href="https://aws.amazon.com/cli/">AWS ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹</a> ã‚’ç”¨ã„ã¦è¡Œã„ã¾ã™ã€‚</p>

<ul>
<li>ã‚¿ã‚¹ã‚¯å®šç¾© (Task Definition) JSON ã‚’ <a href="https://github.com/ngs/Swifton-TodoApp/blob/master/script/ecs-deploy-services.sh">ERB ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</a> ã‹ã‚‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚
</li><li>ã‚¿ã‚¹ã‚¯å®šç¾©ã‚’ã€æ›´æ–°ã€ã‚‚ã—ãã¯ä½œæˆã—ã€<code>swifton-example-production:123</code> ã®æ§˜ãªå½¢å¼ã®æœ€æ–°ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã‚’å–å¾—ã—ã¾ã™ã€‚
</li><li>ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã€æ–°ã—ã„ã‚¿ã‚¹ã‚¯å®šç¾©ã§æ›´æ–°ã€ã‚‚ã—ãã¯ã€ãã‚Œã‚’ç”¨ã„ã¦ä½œæˆã—ã¾ã™ã€‚
</li></ul>

<p>ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨ã€ã‚¦ã‚§ãƒ–ãƒ–ãƒ©ã‚¦ã‚¶ã§ã€ä»¥ä¸‹ã®æ§˜ã« ToDo ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒç¢ºèªã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚</p>

<p><amp-img src="/images/2016-03-04-swift-webapp-on-ecs/todos.png" layout="responsive" width="848" height="518"></amp-img></p>

<p>ãœã²ã€Swift ã§ã® Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºã‚’æ¥½ã—ã‚“ã§ä¸‹ã•ã„ï¼ã‚‚ã—ä½•ã‹ã‚ã‚Œã°ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚</p>

<p><a href="https://github.com/ngs/Swifton-TodoApp">https://github.com/ngs/Swifton-TodoApp</a></p>

    </article>
  </body>
</html>
